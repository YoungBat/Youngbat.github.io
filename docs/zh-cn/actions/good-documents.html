<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>优秀文章 | YoungBat-Team</title>
    <link rel="icon" href="/image/favicon.png" type="image/x-icon" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <script>
        window.param = "zh-cn";
    </script>
    <script src="https://unpkg.com/mammoth@1.4.17/mammoth.browser.min.js"></script>
    <script src="/js/load.js"></script>
</head>
<body style="margin: 0;padding: 0">
<div class="main">
    <div id="head"></div>

    <div class="banner">
        <form id="showForm" style="padding: 20px; max-width: 600px; margin: 0 auto;">
            <label for="searchInput"></label><input type="text"
                                                    id="searchInput"
                                                    placeholder="输入关键词搜索文档..."
                                                    style="width: 80%; padding: 8px; border: 1px solid #ddd;">
            <button type="button"
                    onclick="performSearch()"
                    style="width: 18%; padding: 8px; background-color: #28a745; color: white; border: none;">
                搜索
            </button>
            <div id="searchResults" style="margin-top:10px; display:none;">
                <div id="resultsList" style="border: 1px solid #ddd; max-height: 200px; overflow-y: auto;"></div>
            </div>
            <div id="output" style="margin-top: 15px;padding-top: 15px;border: 1px solid black;display: none"></div>
        </form>
        <script>
            let isSearching = false;
            function fuzzyMatch(searchTerm, fileName) {
                const pattern = searchTerm.toLowerCase();
                const text = fileName.toLowerCase().replace('.docx', '');
                let p = 0;

                for (let t = 0; t < text.length; t++) {
                    if (text[t] === pattern[p]) {
                        if (++p === pattern.length) return true;
                    }
                }
                return false;
            }

            async function performSearch() {
                const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
                const resultsContainer = document.getElementById('searchResults');
                const resultsList = document.getElementById('resultsList');
                if (isSearching) return;
                try {
                    // 获取服务端文件列表
                    const response = await fetch('./FILE-LIST.txt');
                    const fileList = (await response.text()).split('\n').filter(Boolean);
                    isSearching = true;

                    // 模糊匹配逻辑
                    const matchedFiles = fileList.filter(file =>
                        fuzzyMatch(searchTerm, file)
                    );

                    resultsList.innerHTML = matchedFiles.map(file => `
                        <div class="result-item"
                             style="padding:8px; cursor:pointer; border-bottom:1px solid #eee;"
                             data-file="${file}"
                             onclick="loadSelectedFile('${encodeURIComponent(file)}')">
                            ${file.replace('.docx', '')}
                        </div>
                    `).join('');

                    resultsContainer.style.display = matchedFiles.length ? 'block' : 'none';
                    document.getElementById('output').innerHTML = '';

                } catch (error) {
                    console.error('文件列表加载失败:', error);
                    alert('暂时无法获取文档列表');
                }
                finally {
                    isSearching = false;
                }
            }
            async function loadSelectedFile(filename) {
                try {
                    // 添加解码处理
                    const decodedFilename = decodeURIComponent(filename);
                    const response = await fetch(`./docs/${decodedFilename}`);
                    if (!response.ok) {
                        console.error('文件加载失败:', response.statusText);
                        alert('文档加载失败，请检查文件名');
                        return;
                    }

                    const blob = await response.blob();
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        const result = await mammoth.convertToHtml({arrayBuffer: e.target.result});
                        const out = document.getElementById('output');
                        document.getElementById('searchResults').style.display = 'none';
                        out.innerHTML = result.value;
                        out.style.display = 'block';
                    };
                    reader.readAsArrayBuffer(blob);
                } catch (error) {
                    console.error('文件加载失败:', error);
                    alert('文档加载失败，请检查文件名');
                }
            }
        </script>
        <form id="emailForm" onsubmit="return sendViaEmailClient()" style="padding: 20px; max-width: 600px; margin: 0 auto;">
            <div style="margin-bottom: 15px;">
                <label>您的姓名：</label>
                <label for="userName"></label><input type="text" id="userName" required
                                                     style="width: 100%; padding: 8px; margin-top: 5px;"
                                                     placeholder="请输入真实姓名">
            </div>
            <div style="margin-bottom: 15px;">
                <label>介绍内容：</label>
                <label for="emailContent"></label><textarea id="emailContent" required
                                                            style="width: 100%; height: 150px; padding: 8px; margin-top: 5px;"
                                                            placeholder="请输入正文介绍（至少包含20个有效字符）"></textarea>
            </div>
            <button type="submit" style="padding: 10px 20px; background-color: #007bff; color: white; border: none;">
                发送邮件
            </button>
            <div id="errorMsg" style="color: red; margin-top: 10px; display: none;"></div>
            <p><strong><em style="color: #b31d28">*请自行上传附件，大小不超过5MB<br>*格式为：xxx - yourName.docx</em></strong></p>
        </form>
    </div>

    <script>
        // 新增验证函数
        function validateForm() {
            const name = document.getElementById('userName').value.trim();
            const content = document.getElementById('emailContent').value.trim();
            const errorDiv = document.getElementById('errorMsg');

            // 基础正则验证（至少包含1个中文/英文）
            const validRegex = /[\u4e00-\u9fa5a-zA-Z]/;

            if (!validRegex.test(name)) {
                errorDiv.textContent = "姓名需包含有效字符（中文/英文）";
                errorDiv.style.display = 'block';
                return false;
            }

            if (content.length < 20 || !validRegex.test(content)) {
                errorDiv.textContent = "正文需至少20个有效字符（不能全为符号/数字）";
                errorDiv.style.display = 'block';
                return false;
            }

            errorDiv.style.display = 'none';
            alert('验证通过，准备发送邮件...');
            return true;
        }
            function sendViaEmailClient() {
            if (!validateForm()) return false;
            const name = document.getElementById('userName').value.trim();
            const content = document.getElementById('emailContent').value.trim();
                // 打开默认邮件客户端
            window.location.href = `mailto:youngbatfeedback@outlook.com?subject=${encodeURIComponent('文章上传')}&body=${encodeURIComponent(
                `姓名：${name}\n\n介绍：\n${content}`
            )}`;
            return false;
        }
    </script>
    <div id="footer"></div>
</div>
</body>
</html>
